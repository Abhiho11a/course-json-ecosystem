# This is a basic workflow to help you get started with Actions
name: CI
# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  label_previous_prs:
    runs-on: ubuntu-latest
    steps:
      - name: Label previously merged PRs
        env:
          GITHUB_TOKEN: ${{ secrets.PAT }}
        run: |
          page=1
          has_more_pages=true
          while [ "$has_more_pages" = true ]; do
            merged_prs=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?state=closed&per_page=100&page=$page")
            
            # Parse the JSON response to get the PR numbers
            pr_numbers=$(echo "$merged_prs" | jq -r '.[] | select(.merged_at != null) | .number')
            
            for pr_number in $pr_numbers; do
              echo "Adding label to PR #$pr_number"
              curl -s -H "Authorization: token $GITHUB_TOKEN" \
                -X POST \
                -H "Accept: application/vnd.github.v3+json" \
                https://api.github.com/repos/${{ github.repository }}/issues/$pr_number/labels \
                -d '{"labels":["hacktoberfest-accepted"]}'
            done
            
            # Check if there are more pages to fetch
            page=$((page+1))
            has_more_pages=$(echo "$merged_prs" | jq -r '.length == 100')
          done
